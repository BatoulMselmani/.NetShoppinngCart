@model IEnumerable<Product>


@{
    ViewData["Title"] = "Products";
}

<h1 class ="display-4 pb-3"><strong>All Products</strong></h1>
<div class="justify-content-end">
    <form asp-controller="Products" asp-action="Search" method="get">
        <input type="text" name ="searchTerm" placeholder="Search..." >
        <button class="search" type ="submit">Search</button>

    </form>

</div>
<br>
<div class="row">
    <div class="col-12">
        <div class="btn-group mb-3">
            <label class="mr-2">Sort by: </label>
            <a href="/products?categorySlug=@ViewBag.CategorySlug&sortOrder=price_asc" class="btn btn-outline-warning">Price Ascending</a>
            <a href="/products?categorySlug=@ViewBag.CategorySlug&sortOrder=price_desc" class="btn btn-outline-warning">Price Descending</a>
        </div>
    </div>
</div>

<div class="row">
    @foreach( var item in Model) {
        <div class="col-6">
            <div class="ajaxbg d-none">
                <img src="~/images/ajaxloading.gif" />
                <p class="lead alert alert-success text-center d-none">The product has been added!</p>

            </div> 
            <div class="product-container">
            <img src ="~/media/products/@item.Image" class="img-field" alt="" />
            <h4>@item.Name</h4>
            <div>
                @Html.Raw(item.Description)
            </div>
            <p>
                @item.Price.ToString("C2")
            </p>
            <p>
                <a asp-controller="Cart" asp-action="Add" asp-route-id="@item.Id"
                   data-id="@item.Id" class="btn btn-warning addToCart" >Add to cart</a>
                      <button type="button" class="btn" style="background-color:orangered" data-bs-toggle="modal" data-bs-target="#discountModal">
                        Discount
                    </button>
                 <form>
                <div class="modal fade" id="discountModal" tabindex="-1" aria-labelledby="discountModalLabel" aria-hidden="false">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="discountModalLabel">Product Details</h5>
                            </div>
                            <div class="modal-body">
                                <form action="/Discount" method="post">
                                    <input type="hidden" id="product-id" value="1">
                                    <input type="hidden" id="product-price" >

                                    
                                    <p>Product Price: $<span id="displayed-price">@item.Price</span></p>
                                    
                                    <label for="discount-code-input">Enter Discount Code:</label>
                                    <input type="text" id="discount-code-input">

                                     <button asp-controller="Cart" asp-action="Discount" id="add-to-cart-button" class="btn btn-warning">Add to cart</button>

                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                </form>

            </p>


        </div>
        </div>

    }
    
    @if (ViewBag.TotalPages > 1)
    {
    <div class="d-flex w-100 justify-content-center"> 
<pagination page-count="@ViewBag.TotalPages" page-target="/products" 
page-number="@ViewBag.PageNumber" page-range="@ViewBag.PageRange"></pagination></div>

    }
</div>
@section Scripts{
   
    <script>
        $(function()
        {
            $("a.addToCart").click(function (e) {
    e.preventDefault();

    let ajaxDiv = $(this).parent().parent().find("div.ajaxbg");
    ajaxDiv.removeClass("d-none");
    let id = $(this).data.("id");

    $.get('/cart/add' + id, {}, function(data){
        $("div.smallcart").html(data);
        ajaxDiv.find("img").addClass("d-none");
        ajaxDiv.find("p").removeClass("d-none");
        setTimeout(() => {
            ajaxDiv.animate({opacity: 0}, function(){
                $(this).addClass("d-none").fadeTo(.1, 1);
                $(this).find("img").removeClass("d-none");
                  $(this).find("p").addClass("d-none");
            })
        })
           });


       });
        });

             $(document).ready(function () {
        $("#add-to-cart-button").click(function () {
            var productId = $("#product-id").val();
            var productPrice = parseFloat($("#product-price").val());
            var discountCode = $("#discount-code-input").val().trim();

            // Send an AJAX request to the server to add the product to the cart
            $.ajax({
                type: "POST",
                url: "/Cart/AddToCart",
                data: {
                    productId: productId,
                    productPrice: productPrice,
                    discountCode: discountCode
                },
                success: function (data) {
                    if (data.success) {
                        alert(data.message);

                        // Update the product price on the page
                        var finalPrice = data.finalPrice;
                        $("#product-price").val(finalPrice.toFixed(2));
                    } else {
                        alert("Failed to add product to cart.");
                    }
                },
                error: function () {
                    alert("An error occurred while adding the product to the cart.");
                }
            });
        });
    });
    </script>
 
}
